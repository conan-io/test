version: "3.8"

networks:
  my_network:
    name: my_network
    driver: bridge

services:
  postgres:
    image: postgres:13
    container_name: postgres
    restart: always
    environment:
      POSTGRES_DB: artifactory
      POSTGRES_USER: artifactory
      POSTGRES_PASSWORD: password
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U artifactory"]
      interval: 30s
      retries: 5
    ulimits:
      nproc: 65535
      nofile:
        soft: 32000
        hard: 40000
    networks:
      - my_network

  artifactory:
    image: releases-docker.jfrog.io/jfrog/artifactory-pro:${ARTIFACTORY_VERSION}
    container_name: artifactory
    restart: always
    environment:
      JF_SHARED_DATABASE_TYPE: postgresql
      JF_SHARED_DATABASE_DRIVER: org.postgresql.Driver
      JF_SHARED_DATABASE_URL: jdbc:postgresql://postgres:5432/artifactory
      JF_SHARED_DATABASE_USER: artifactory
      JF_SHARED_DATABASE_PASSWORD: password
      ARTIFACTORY_ADMIN_PASSWORD: password
    ports:
      - 8081:8081
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/artifactory/api/system/ping"]
      interval: 30s
      retries: 5
    ulimits:
      nproc: 65535
      nofile:
        soft: 32000
        hard: 40000
    networks:
      - my_network

  test_runner:
    build:
      context: ./test_runner
    command: "/bin/bash"
    depends_on:
      - artifactory
    environment:
      - CONAN_GIT_REPO=$CONAN_GIT_REPO
      - CONAN_GIT_TAG=$CONAN_GIT_TAG
      - ART_LICENSE=$ART_LICENSE
    networks:
      - my_network
