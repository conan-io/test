version: '3.8'

services:
  artifactory:
    image: releases-docker.jfrog.io/jfrog/artifactory-pro:${ARTIFACTORY_VERSION}
    environment:
      - JF_ROUTER_ENTRYPOINTS_EXTERNALPORT=8082
    ports:
      - "8082:8082" # Router communication
      - "8081:8081" # Artifactory communication
    volumes:
      - "${ROOT_DATA_DIR}:/opt/jfrog/artifactory/var"
    logging:
      driver: json-file
      options:
        max-size: "50m"
        max-file: "10"
    ulimits:
      nproc: 65535
      nofile:
        soft: 32000
        hard: 40000
    networks:
      - artifactory_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/artifactory/api/system/ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  test_runner:
    build:
      context: ./test_runner
    depends_on:
      - artifactory
    environment:
      - CONAN_GIT_REPO=https://github.com/conan-io/conan.git
      - CONAN_GIT_TAG=${CONAN_GIT_TAG}
      - ART_LICENSE=${ART_LICENSE}
      - ARTIFACTORY_USER=admin
      - ARTIFACTORY_PASSWORD=password
      - ARTIFACTORY_DEFAULT_URL=http://artifactory:8081/artifactory
    networks:
      - artifactory_network

networks:
  artifactory_network:
    driver: bridge
